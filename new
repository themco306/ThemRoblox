-- Dịch vụ Roblox
local player = game.Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local StarterGui = game:GetService("StarterGui")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

player.CharacterAdded:Connect(function(newChar)
	character = newChar
end)

-- GUI
local screenGui = Instance.new("ScreenGui")
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

-- Nhập tên player
local playerNameInput = Instance.new("TextBox")
playerNameInput.Size = UDim2.new(0, 300, 0, 40)
playerNameInput.Position = UDim2.new(0.5, -150, 0.25, 0)
playerNameInput.Text = "Nhập tên người chơi"
playerNameInput.Visible = false
playerNameInput.Parent = screenGui

-- Các nút
local flyButton = Instance.new("TextButton")
flyButton.Size = UDim2.new(0, 200, 0, 35)
flyButton.Position = UDim2.new(0.5, -100, 0.32, 0)
flyButton.Text = "Bay đến"
flyButton.Visible = false
flyButton.Parent = screenGui

local stopButton = Instance.new("TextButton")
stopButton.Size = UDim2.new(0, 200, 0, 35)
stopButton.Position = UDim2.new(0.5, -100, 0.38, 0)
stopButton.Text = "Ngừng"
stopButton.Visible = false
stopButton.Parent = screenGui

local speedButton = Instance.new("TextButton")
speedButton.Size = UDim2.new(0, 200, 0, 35)
speedButton.Position = UDim2.new(0.5, -100, 0.44, 0)
speedButton.Text = "Tốc độ: 200"
speedButton.Visible = false
speedButton.Parent = screenGui

local savePointButton = Instance.new("TextButton")
savePointButton.Size = UDim2.new(0, 200, 0, 35)
savePointButton.Position = UDim2.new(0.5, -100, 0.50, 0)
savePointButton.Text = "Lưu điểm"
savePointButton.Visible = false
savePointButton.Parent = screenGui

-- Frame hiển thị danh sách điểm
local returnFrame = Instance.new("ScrollingFrame")
returnFrame.Size = UDim2.new(0, 250, 0, 200)
returnFrame.Position = UDim2.new(0.5, -125, 0.6, 0)
returnFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
returnFrame.CanvasSize = UDim2.new(0,0,0,0)
returnFrame.ScrollBarThickness = 6
returnFrame.Visible = false
returnFrame.Parent = screenGui

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.Parent = returnFrame
UIListLayout.Padding = UDim.new(0, 5)

-- Toggle GUI
local teleButton = Instance.new("TextButton")
teleButton.Size = UDim2.new(0, 150, 0, 40)
teleButton.Position = UDim2.new(0.4, -75, 0.85, 0)
teleButton.Text = "Tele2Player"
teleButton.Parent = screenGui

-- Biến
local flightSpeed = 200
local isFlying = false
local currentTween
local isGuiVisible = false
local savedPoints = {}
local noclipConnection = nil

-- NoClip
local function enableNoClip()
	if noclipConnection then return end
	noclipConnection = RunService.Stepped:Connect(function()
		if character then
			for _, part in pairs(character:GetDescendants()) do
				if part:IsA("BasePart") then
					part.CanCollide = false
				end
			end
		end
	end)
end
local function disableNoClip()
	if noclipConnection then
		noclipConnection:Disconnect()
		noclipConnection = nil
	end
end

-- Stop bay
local function stopFlying()
	if isFlying and currentTween then
		currentTween:Cancel()
	end
	isFlying = false
	disableNoClip()
end

-- Bay tới player
local function flyToPlayerByName()
	if isFlying then return end
	isFlying = true
	local inputText = playerNameInput.Text:lower()
	local targetPlayer = nil
	for _, p in pairs(Players:GetPlayers()) do
		if p.Name:lower():sub(1, #inputText) == inputText then
			targetPlayer = p
			break
		end
	end
	if targetPlayer and targetPlayer.Character then
		local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
		local targetPart = targetPlayer.Character:WaitForChild("HumanoidRootPart")
		local distance = (humanoidRootPart.Position - targetPart.Position).Magnitude
		local travelTime = distance / flightSpeed
		if currentTween then currentTween:Cancel() end
		local tweenInfo = TweenInfo.new(travelTime, Enum.EasingStyle.Linear)
		local tweenGoal = {CFrame = CFrame.new(targetPart.Position)}
		currentTween = TweenService:Create(humanoidRootPart, tweenInfo, tweenGoal)
		currentTween:Play()
		enableNoClip()
		task.spawn(function()
			while isFlying and character and character:FindFirstChild("HumanoidRootPart") do
				local currentDistance = (humanoidRootPart.Position - targetPart.Position).Magnitude
				if currentDistance <= 2 then stopFlying() break end
				task.wait(0.1)
			end
		end)
	else
		StarterGui:SetCore("SendNotification",{Title="Lỗi",Text="Không tìm thấy người chơi!",Duration=3})
		stopFlying()
	end
end

-- Đổi tốc độ
local function changeSpeed()
	if flightSpeed == 200 then
		flightSpeed = 300
		speedButton.Text = "Tốc độ: 300"
	elseif flightSpeed == 300 then
		flightSpeed = 400
		speedButton.Text = "Tốc độ: 400"
	else
		flightSpeed = 200
		speedButton.Text = "Tốc độ: 200"
	end
end

-- Lưu điểm (có đặt tên)
local function saveCurrentPoint()
	if character and character:FindFirstChild("HumanoidRootPart") then
		local pos = character.HumanoidRootPart.Position
		-- TextBox để nhập tên
		local nameBox = Instance.new("TextBox")
		nameBox.Size = UDim2.new(0,200,0,35)
		nameBox.Position = UDim2.new(0.5,-100,0.56,40)
		nameBox.PlaceholderText = "Nhập tên điểm..."
		nameBox.Text = ""
		nameBox.Parent = screenGui

		nameBox.FocusLost:Connect(function(enterPressed)
			if enterPressed and nameBox.Text ~= "" then
				local pointName = nameBox.Text
				table.insert(savedPoints,{Name=pointName,Position=pos})

				local index = #savedPoints
				local pointFrame = Instance.new("Frame")
				pointFrame.Size = UDim2.new(1,0,0,35)
				pointFrame.BackgroundColor3 = Color3.fromRGB(60,60,60)
				pointFrame.Parent = returnFrame

				local pointButton = Instance.new("TextButton")
				pointButton.Size = UDim2.new(0.7,0,1,0)
				pointButton.Text = pointName
				pointButton.Parent = pointFrame

				local delButton = Instance.new("TextButton")
				delButton.Size = UDim2.new(0.3,0,1,0)
				delButton.Position = UDim2.new(0.7,0,0,0)
				delButton.Text = "Xóa"
				delButton.Parent = pointFrame

				-- Bay về điểm này
				pointButton.MouseButton1Click:Connect(function()
					local targetPosition = savedPoints[index].Position
					local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
					local distance = (humanoidRootPart.Position - targetPosition).Magnitude
					local travelTime = distance / flightSpeed
					if currentTween then currentTween:Cancel() end
					local tweenInfo = TweenInfo.new(travelTime, Enum.EasingStyle.Linear)
					local tweenGoal = {CFrame = CFrame.new(targetPosition)}
					currentTween = TweenService:Create(humanoidRootPart, tweenInfo, tweenGoal)
					currentTween:Play()
					enableNoClip()
					isFlying = true
					task.spawn(function()
						while isFlying and character and character:FindFirstChild("HumanoidRootPart") do
							local currentDistance = (humanoidRootPart.Position - targetPosition).Magnitude
							if currentDistance <= 2 then stopFlying() break end
							task.wait(0.1)
						end
					end)
				end)

				-- Xóa điểm
				delButton.MouseButton1Click:Connect(function()
					pointFrame:Destroy()
					savedPoints[index] = nil
				end)

				StarterGui:SetCore("SendNotification",{Title="Đã lưu",Text="Điểm: "..pointName,Duration=3})
				nameBox:Destroy()
			else
				nameBox:Destroy()
			end
		end)
	end
end

-- Toggle GUI
local function toggleAllGUI()
	local state = not isGuiVisible
	playerNameInput.Visible = state
	flyButton.Visible = state
	stopButton.Visible = state
	speedButton.Visible = state
	savePointButton.Visible = state
	returnFrame.Visible = state
	isGuiVisible = state
end

-- Gán sự kiện
teleButton.MouseButton1Click:Connect(toggleAllGUI)
flyButton.MouseButton1Click:Connect(flyToPlayerByName)
stopButton.MouseButton1Click:Connect(stopFlying)
speedButton.MouseButton1Click:Connect(changeSpeed)
savePointButton.MouseButton1Click:Connect(saveCurrentPoint)

-- Kéo nút Tele2Player
local dragging, dragStart, startPos = false, nil, nil
teleButton.MouseButton1Down:Connect(function(input)
	dragging = true
	dragStart = input.Position
	startPos = teleButton.Position
end)
UserInputService.InputChanged:Connect(function(input)
	if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
		local delta = input.Position - dragStart
		teleButton.Position = UDim2.new(startPos.X.Scale,startPos.X.Offset+delta.X,startPos.Y.Scale,startPos.Y.Offset+delta.Y)
	end
end)
UserInputService.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
end)
